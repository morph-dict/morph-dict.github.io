<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>
    <script src="jquery-2.1.4.min.js" type="text/javascript"></script>
    <script>

        function jqPromise(def) {
            return new Promise(function(done, fail){
                def.done(done).fail(fail);
            })
        }

        function indexResolver(perFile) {
            return function(index) {
                return {
                    base: Math.floor(index / perFile),
                    offset: index % perFile
                }
            }
        }

        function search(toSearch) {
            var dataRoot = "data";


            return jqPromise($.ajax(dataRoot+"/index.json")).then(function(indexFile){
                var index = indexResolver(indexFile.itemsPerFile);
                var treeDir = dataRoot + "/" + indexFile.treeDir;
                var dictLexDir = dataRoot + "/" + indexFile.dictLexDir;

                return new Promise(function (resolve, fail) {
                    function search(nextNodeIndex, rest) {

                        nextNodeIndex = index(nextNodeIndex);

                        var file = treeDir + "/" + nextNodeIndex.base + ".json";
                        jqPromise($.ajax(file)).then(function (data) {
                            var next = data[nextNodeIndex.offset];
                            if (rest.length == 0) {
                                if (next[1]) {
                                    resolve(next[1]);
                                }
                                else {
                                    fail({status: "not_found", data: toSearch});
                                }
                            }
                            else {
                                var branches = next[0];
                                var branchIndex = branches[rest.charAt(0)];
                                if (branchIndex) {
                                    search(branchIndex, rest.substr(1));
                                }
                                else {
                                    fail({status: "not_found", data: toSearch});
                                }
                            }
                        }).catch(function (xhr, e) {
                            fail(e);
                        })
                    }
                    search(indexFile.root, toSearch);
                })

                // Make it looks better
                .then(function(data){
                    return data.map(function(x){
                        return {
                            ancode: x[0],
                            lexemeRec: x[1]
                        }
                    });
                })

                // Fetch lexeme rec
                .then(function(data){
                    return Promise.all(data.map(function(node){
                        var idx = index(node.lexemeRec);
                        var fileName = dictLexDir + "/"  + idx.base + ".json";
                        return jqPromise($.ajax(fileName)).then(function(lexemeRecFile){
                            var lexemeRec = lexemeRecFile[idx.offset];
                            lexemeRec = {
                                basis: lexemeRec[0],
                                paradigmNum: lexemeRec[1],
                                accentParadigmNum: lexemeRec[2],
                                userSessionNum: lexemeRec[3],
                                ancode: lexemeRec[4],
                                prefixParadigmNum: lexemeRec[5]
                            };
                            return {
                                ancode: node.ancode,
                                lexemeRec: lexemeRec
                            }
                        })
                    }))
                })

                .then(function(data){
                    console.log(data);
                    return data;
                })

            });
        }

        $(function () {
            $("#search").submit(function(e){
                var toSearch = $("#word").val();
                $("#result").text("searching...");
                search(toSearch).then(function(result){
                    $("#result").text(JSON.stringify(result));
                }).catch(function(e){
                    throw e;
                });
                e.preventDefault();
            });
        })
    </script>
</head>
<body>
<form id="search">
    <p><label>Word form: <input type="text" id="word" value="частнопредпринимательский"/></label><button type="submit">Search</button></p>
    <p><label>Result: <span id="result"></span></label></p>
</form>
</body>
</html>